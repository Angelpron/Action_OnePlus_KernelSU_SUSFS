name: Auto-update CPU/FEIL options

on:
  schedule:
    - cron: "0 0 * * *"      # 每天 UTC 00:00 同步
  workflow_dispatch:

permissions:
  contents: write

jobs:
  update-options:
    runs-on: ubuntu-latest
    env:
      WF_FILE: .github/workflows/Build-SukiSU-Ultra.yml
      UPSTREAM_REPO: OnePlusOSS/kernel_manifest

    steps:
      - name: Checkout with PAT
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.PAT_TOKEN }}
          fetch-depth: 0

      - name: Install dependencies
        run: |
          set -Eeuo pipefail
          sudo apt-get update -y
          sudo apt-get install -y jq curl
          curl -fsSL "https://github.com/mikefarah/yq/releases/download/v4.44.3/yq_linux_amd64" \
            -o /usr/local/bin/yq && sudo chmod +x /usr/local/bin/yq

      - name: Generate CPU & FEIL lists
        shell: bash
        run: |
          set -Eeuo pipefail
          # 拉取所有分支
          git ls-remote --heads "https://github.com/${UPSTREAM_REPO}.git" \
            | awk '{print $2}' | sed 's#refs/heads/##' > branches.txt

          # CPU → sm<digits>
          grep -E '^.*/sm[0-9]+' branches.txt | sed 's#.*/##' | sort -u > cpu_list.txt

          # FEIL → 所有 xml 源自每个分支
          : > xml_names.txt
          while read -r branch; do
            ref=${branch//\//%2F}
            api="https://api.github.com/repos/${UPSTREAM_REPO}/git/trees/${ref}?recursive=1"
            resp=$(curl -sS \
              -H "Authorization: Bearer ${{ secrets.PAT_TOKEN }}" \
              -H "Accept: application/vnd.github+json" \
              "$api" || true)

            # 用 guard 阻止非 string 或 null 导致 endswith 错误
            echo "$resp" \
              | jq -r '(.tree // [])[]
                       | select(.type=="blob" and (.path|strings|endswith(".xml")))
                       | .path' \
              | sed -E 's#.*/##; s/\.xml$//' \
              >> xml_names.txt

            sleep 0.2
          done < branches.txt
          sort -u xml_names.txt -o xml_names.txt

      - name: Update workflow_dispatch inputs
        shell: bash
        run: |
          set -Eeuo pipefail
          for NAME in CPU FEIL; do
            LIST_VAR="${NAME,,}_list.txt"
            yq -i ".on.workflow_dispatch.inputs.${NAME}.options = []" "$WF_FILE"
            [ -s "$LIST_VAR" ] || continue
            while read -r v; do
              yq -i ".on.workflow_dispatch.inputs.${NAME}.options += [\"$v\"]" "$WF_FILE"
            done < "$LIST_VAR"

            # 校验 default
            DEF_PATH=".on.workflow_dispatch.inputs.${NAME}.default"
            CUR=$(yq -r "${DEF_PATH} // \"\"" "$WF_FILE")
            if ! grep -qxF "$CUR" "$LIST_VAR"; then
              NEW=$(head -n1 "$LIST_VAR")
              [ -n "$NEW" ] && yq -i "${DEF_PATH} = \"${NEW}\"" "$WF_FILE"
            fi
          done

      - name: Commit & push if changed
        shell: bash
        run: |
          set -Eeuo pipefail
          if git diff --quiet; then
            echo "No changes."
            exit 0
          fi
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git add "$WF_FILE"
          git commit -m "chore: auto-update CPU and FEIL options"
          git remote set-url origin https://${{ secrets.PAT_TOKEN }}@github.com/${{ github.repository }}
          git push origin HEAD:main
